<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3416 æˆ°ç•¥æŒ‡æ®å®˜ | V32</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', -apple-system, sans-serif; background-color: #f8fafc; color: #1e293b; }
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
        
        .card { 
            background: white; 
            border-radius: 1.5rem; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.02); 
            border: 1px solid #f1f5f9; 
        }
        
        input, select { 
            background-color: #f1f5f9; 
            border: 1px solid #e2e8f0; 
            border-radius: 0.75rem; 
            transition: all 0.2s;
            color: #0f172a;
        }
        input:focus, select:focus { 
            border-color: #6366f1; 
            background-color: #fff;
            outline: none; 
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); 
        }

        .btn-press:active { transform: scale(0.97); transition: 0.1s; }
        
        .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .dot-green { background-color: #10b981; box-shadow: 0 0 8px #10b981; }
        .dot-red { background-color: #ef4444; }

        .chart-glow { filter: drop-shadow(0 10px 8px rgba(0,0,0,0.05)); }
        
        .mode-active-buy { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); color: white; border: none; }
        .mode-active-sell { background: linear-gradient(135deg, #e11d48 0%, #be123c 100%); color: white; border: none; }
        .mode-inactive { background: #f1f5f9; color: #94a3b8; }

        .delete-btn {
            background: none;
            border: none;
            color: #ef4444;
            opacity: 0.5;
            transition: opacity 0.2s;
            padding: 5px;
            margin-right: -5px;
        }
        .delete-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .chart-toggle-btn {
            padding: 4px 10px;
            font-size: 10px;
            font-weight: 700;
            border-radius: 9999px;
            transition: all 0.2s;
        }
        .chart-toggle-active {
            background-color: #6366f1;
            color: white;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);
        }
        .chart-toggle-inactive {
            background-color: #e2e8f0;
            color: #64748b;
        }
    </style>
</head>
<body class="pb-12">

    <div class="bg-white/80 backdrop-blur px-5 py-3 flex justify-between items-center sticky top-0 z-50 border-b border-slate-100">
        <div>
            <h1 class="text-lg font-black tracking-tight text-slate-800">3416 æŒ‡æ®å®˜</h1>
            <p class="text-[10px] text-indigo-500 font-bold tracking-widest">V32 UI OPTIMIZED</p>
        </div>
        <div class="flex flex-col items-end">
            <div class="flex items-center gap-2">
                <span id="syncDot" class="dot dot-red"></span>
                <span id="syncStatus" class="text-xs font-bold text-slate-400">é€£ç·šä¸­...</span>
            </div>
            <span id="lastSyncTime" class="text-[10px] text-slate-300 mono mt-0.5">--:--</span>
        </div>
    </div>

    <div class="max-w-md mx-auto p-4 space-y-4">
        
        <div class="card p-6 text-center bg-gradient-to-b from-white to-slate-50">
            <p class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-2">ç¸½è³‡ç”¢æ·¨å€¼</p>
            <div class="flex justify-center items-baseline gap-2 mb-6">
                <h2 id="totalEquity" class="text-5xl font-black text-slate-800 mono tracking-tighter drop-shadow-sm">$1,000,000</h2>
                <span id="totalRoi" class="bg-emerald-100 text-emerald-700 px-2 py-1 rounded-md text-xs font-bold">+0.0%</span>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="bg-white p-3 rounded-2xl border border-slate-100 shadow-sm">
                    <p class="text-[10px] text-slate-400 font-bold uppercase">å¯ç”¨ç¾é‡‘</p>
                    <p id="cashBal" class="text-lg font-bold text-slate-700 mono">$1,000,000</p>
                </div>
                <div class="bg-white p-3 rounded-2xl border border-slate-100 shadow-sm">
                    <p class="text-[10px] text-yellow-500 font-bold uppercase">ç´¯ç©æ”¶æ¯</p>
                    <p id="totalDividends" class="text-lg font-bold text-yellow-600 mono">$0</p>
                </div>
                <div class="bg-white p-3 rounded-2xl border border-slate-100 shadow-sm">
                    <p class="text-[10px] text-orange-500 font-bold uppercase">æ³¢å¹…æ·¨åˆ©</p>
                    <p id="swingProfit" class="text-lg font-bold text-orange-600 mono">$0</p>
                </div>
                <div class="bg-white p-3 rounded-2xl border border-slate-100 shadow-sm">
                    <p class="text-[10px] text-rose-500 font-bold uppercase">æ’ˆåº•æ·¨åˆ©</p>
                    <p id="bottomProfit" class="text-lg font-bold text-rose-600 mono">$0</p>
                </div>
            </div>
        </div>

        <div class="card p-5">
            <div class="flex flex-col items-center">
                <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4 w-full text-left">è³‡ç”¢é…ç½®åˆ†ä½ˆ</h3>
                
                <div class="relative w-48 h-48 mb-4 chart-glow">
                    <canvas id="allocChart"></canvas>
                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <span class="text-xs font-bold text-slate-300">ASSET</span>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-2 w-full">
                    <div class="text-center p-2 rounded-xl bg-blue-50 border border-blue-100">
                        <span class="block text-[10px] font-bold text-blue-400 uppercase">é•·ç·šæ ¸å¿ƒ</span>
                        <span id="v1_label" class="block text-sm font-black text-blue-600 mono">0%</span>
                    </div>
                    <div class="text-center p-2 rounded-xl bg-orange-50 border border-orange-100">
                        <span class="block text-[10px] font-bold text-orange-400 uppercase">æ³¢å¹…çŸ­ç·š</span>
                        <span id="v2_label" class="block text-sm font-black text-orange-600 mono">0%</span>
                    </div>
                    <div class="text-center p-2 rounded-xl bg-rose-50 border border-rose-100">
                        <span class="block text-[10px] font-bold text-rose-400 uppercase">ä½ä½æ’ˆåº•</span>
                        <span id="v3_label" class="block text-sm font-black text-rose-600 mono">0%</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card p-5 border-l-4 border-l-indigo-500 bg-white">
            <div class="flex justify-between items-start mb-1">
                <span class="text-[10px] font-bold text-slate-400 uppercase">AI æ¯ç‡è©•ä¼°</span>
                <span id="yieldValue" class="text-xl font-black text-indigo-600 mono">--%</span>
            </div>
            <h3 id="adviceSignal" class="text-md font-bold text-slate-800">ç­‰å¾…æ•¸æ“š...</h3>
            <p id="adviceDesc" class="text-xs text-slate-500 mt-1">åˆ†æä¸­...</p>
            
            <div class="mt-3 pt-3 border-t border-slate-100 flex justify-between items-center">
                <div class="flex items-center gap-1">
                    <span class="text-[10px] font-bold text-slate-400">æ´¾æ¯æ—¥è¨­å®š:</span>
                    <select id="divDaySelect" onchange="updateUI()" class="py-0 px-2 text-xs font-bold bg-slate-100 border-none rounded">
                        </select>
                </div>
                <span id="countdown" class="text-xs font-black text-indigo-500 bg-indigo-50 px-2 py-1 rounded">å‰©é¤˜ -- å¤©</span>
            </div>
        </div>
        
        <div class="card p-6 relative overflow-hidden">
            <h3 class="text-xs font-black text-slate-400 uppercase mb-4 tracking-widest">äº¤æ˜“æ§åˆ¶å°</h3>

            <div class="grid grid-cols-2 gap-2 mb-4">
                <button id="buyModeBtn" onclick="switchMode('BUY')" class="py-3 rounded-xl font-bold text-sm transition btn-press mode-active-buy shadow-lg shadow-slate-200">è²·å…¥ (BUY)</button>
                <button id="sellModeBtn" onclick="switchMode('SELL')" class="py-3 rounded-xl font-bold text-sm transition btn-press mode-inactive">æ²½å‡º (SELL)</button>
            </div>

            <div class="space-y-3 mb-4">
                <select id="bucket" onchange="updateUI()" class="w-full p-3 font-bold text-sm bg-white border-2 border-slate-100 focus:border-indigo-500">
                    <option value="longTerm">ğŸ”µ é•·ç·šæ ¸å¿ƒ (40%)</option>
                    <option value="swing">ğŸŸ  æ³¢å¹…çŸ­ç·š (30%)</option>
                    <option value="bottom">ğŸ”´ ä½ä½æ’ˆåº• (30%)</option>
                </select>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 mb-1">å¸‚åƒ¹ (HKD)</label>
                        <div class="flex">
                            <input type="number" id="price" value="10.50" step="0.01" oninput="updateUI()" class="w-full font-black mono text-slate-800 p-2 text-center text-lg">
                            <button onclick="syncMarket(true)" class="ml-1 text-indigo-500 p-2 font-bold">â†»</button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 mb-1">æœˆæ¯ (HKD)</label>
                        <input type="number" id="divSetting" value="0.140" step="0.001" oninput="updateUI()" class="w-full font-black mono text-emerald-600 p-2 text-center text-lg bg-emerald-50/50 border-emerald-100">
                    </div>
                </div>
            </div>

            <div class="bg-slate-50 rounded-2xl p-4 border border-slate-100 mb-4">
                <div class="flex justify-between items-center mb-2">
                    <label class="text-[10px] font-bold text-slate-500 uppercase">è‚¡æ•¸</label>
                    <span id="avgCostDisplay" class="text-[9px] font-bold text-slate-400 bg-white px-2 py-0.5 rounded shadow-sm">å‡åƒ¹: $0.00</span>
                </div>
                
                <div class="relative mb-3">
                    <input type="number" id="shares" value="1000" oninput="updateUI()" class="w-full text-3xl font-black mono text-center text-slate-800 bg-white py-3 border border-slate-200 rounded-xl focus:border-slate-800 shadow-inner">
                    <button onclick="setMax()" class="absolute right-2 top-2 bg-slate-200 text-slate-600 hover:bg-slate-300 text-[9px] font-bold px-2 py-1 rounded transition">MAX</button>
                </div>

                <div class="space-y-2">
                    <div class="flex justify-between items-center text-sm">
                        <span class="text-slate-40-0 font-bold text-xs">ç¸½é‡‘é¡</span>
                        <span id="estAmount" class="font-black mono text-slate-700">$0</span>
                    </div>
                    
                    <div id="limitRow" class="flex justify-between items-center p-2 rounded-lg bg-indigo-50 border border-indigo-100 text-indigo-800">
                        <span class="text-xs font-bold flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                            ä»½é¡å‰©é¤˜é¡åº¦
                        </span>
                        <span id="bucketLimit" class="font-black mono text-md">+$400,000</span>
                    </div>

                    <div id="projectedDivRow" class="flex justify-between items-center p-2 rounded-lg bg-emerald-100/50 border border-emerald-100 text-emerald-800">
                        <span class="text-xs font-bold flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                            é è¨ˆæ¯æœˆå¢æ”¶
                        </span>
                        <span id="projectedDiv" class="font-black mono text-md">+$0</span>
                    </div>

                    <div id="profitIndicator" class="hidden flex justify-between items-center p-2 rounded-lg text-sm">
                        <span class="font-bold text-xs">å¸³é¢å›å ±</span>
                        <span id="profitPct" class="font-black mono text-md">0.00%</span>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-4 gap-2">
                <button onclick="execute()" id="execBtn" class="col-span-3 py-4 bg-slate-800 text-white rounded-xl font-bold text-md shadow-lg shadow-slate-300/50 btn-press">ç¢ºèªäº¤æ˜“</button>
                <button onclick="collectDiv()" class="col-span-1 bg-amber-400 text-amber-950 rounded-xl font-bold text-xs flex flex-col items-center justify-center shadow-lg shadow-amber-200 btn-press">
                    <span class="text-lg">ğŸ’°</span>
                    æ”¶æ¯
                </button>
            </div>
        </div>
        <div class="card p-5">
            <h3 class="text-xs font-black text-slate-400 uppercase mb-4 tracking-widest">ä»½é¡æŒå€‰æ¦‚æ³ (åŸºæ–¼å¸‚åƒ¹)</h3>
            <div class="space-y-3">
                <div id="longTermStats" class="p-3 rounded-xl bg-blue-50 border border-blue-100 flex justify-between items-center">
                    <div>
                        <span class="block text-[10px] font-bold text-blue-500 uppercase">ğŸ”µ é•·ç·šæ ¸å¿ƒ (40%)</span>
                        <span class="block text-xs text-blue-400">å‡åƒ¹: <span id="longTermAvg" class="font-bold mono">0.00</span> | æŒå€‰: <span id="longTermShares" class="font-bold mono">0</span>è‚¡</span>
                    </div>
                    <div class="text-right">
                        <span id="longTermPL" class="block text-sm font-black text-slate-800 mono">+$0</span>
                        <span id="longTermPLPct" class="block text-[10px] font-bold text-slate-600">0.00%</span>
                    </div>
                </div>
                <div id="swingStats" class="p-3 rounded-xl bg-orange-50 border border-orange-100 flex justify-between items-center">
                    <div>
                        <span class="block text-[10px] font-bold text-orange-500 uppercase">ğŸŸ  æ³¢å¹…çŸ­ç·š (30%)</span>
                        <span class="block text-xs text-orange-400">å‡åƒ¹: <span id="swingAvg" class="font-bold mono">0.00</span> | æŒå€‰: <span id="swingShares" class="font-bold mono">0</span>è‚¡</span>
                    </div>
                    <div class="text-right">
                        <span id="swingPL" class="block text-sm font-black text-slate-800 mono">+$0</span>
                        <span id="swingPLPct" class="block text-[10px] font-bold text-slate-600">0.00%</span>
                    </div>
                </div>
                <div id="bottomStats" class="p-3 rounded-xl bg-rose-50 border border-rose-100 flex justify-between items-center">
                    <div>
                        <span class="block text-[10px] font-bold text-rose-500 uppercase">ğŸ”´ ä½ä½æ’ˆåº• (30%)</span>
                        <span class="block text-xs text-rose-400">å‡åƒ¹: <span id="bottomAvg" class="font-bold mono">0.00</span> | æŒå€‰: <span id="bottomShares" class="font-bold mono">0</span>è‚¡</span>
                    </div>
                    <div class="text-right">
                        <span id="bottomPL" class="block text-sm font-black text-slate-800 mono">+$0</span>
                        <span id="bottomPLPct" class="block text-[10px] font-bold text-slate-600">0.00%</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="card p-5">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">ç¸½è³‡ç”¢æ·¨å€¼èµ°å‹¢</h3>
                <div class="flex gap-2">
                    <button id="toggleMonthly" onclick="renderPerformanceChart('monthly')" class="chart-toggle-btn chart-toggle-active">æœˆåº¦</button>
                    <button id="toggleYearly" onclick="renderPerformanceChart('yearly')" class="chart-toggle-btn chart-toggle-inactive">å¹´åº¦</button>
                </div>
            </div>
            <div style="height: 200px;">
                <canvas id="performanceChart"></canvas>
            </div>
        </div>

        <div class="card overflow-hidden">
            <div class="bg-slate-50 px-5 py-3 border-b border-slate-100 flex justify-between items-center">
                <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">äº¤æ˜“æ—¥èªŒ</h3>
                <button onclick="resetData()" class="text-[10px] text-rose-400 font-bold hover:text-rose-600">é‡ç½®</button>
            </div>
            <div id="logBody" class="max-h-40 overflow-y-auto divide-y divide-slate-50"></div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = '3416_v31_hold_control'; // é›–ç„¶æ˜¯ V32ï¼Œä½†ä¿æŒ KEY ä¸è®Šä»¥ç¹¼æ‰¿æ•¸æ“š
        const TOTAL_CAPITAL = 1000000;
        const RATIOS = { longTerm: 0.40, swing: 0.30, bottom: 0.30 };
        const NAMES = { longTerm: 'é•·ç·š', swing: 'æ³¢å¹…', bottom: 'æ’ˆåº•' };
        
        const INITIAL_PRICE = 10.50; 
        const INITIAL_DIV = 0.140;

        let currentMode = 'BUY';
        let allocChart = null;
        let performanceChart = null;
        let currentChartMode = 'monthly';
        
        const DEFAULT_STATE = {
            cash: TOTAL_CAPITAL,
            holding: { longTerm: 0, swing: 0, bottom: 0 },
            used: { longTerm: 0, swing: 0, bottom: 0 },
            logs: [],
            totalDividends: 0, 
            divDay: 7, 
            swingProfit: 0,
            bottomProfit: 0,
            performanceHistory: [{ date: new Date().toISOString().substring(0, 10), equity: TOTAL_CAPITAL }]
        };
        
        let state = {};

        try {
            const storedState = JSON.parse(localStorage.getItem(STORAGE_KEY));
            if (storedState) {
                // ç¢ºä¿æ‰€æœ‰æ–°å±¬æ€§å­˜åœ¨ï¼Œä¸¦è™•ç†èˆŠæ•¸æ“šé·ç§»
                if (!storedState.performanceHistory || storedState.performanceHistory.length === 0) {
                     storedState.performanceHistory = DEFAULT_STATE.performanceHistory;
                }
                if (storedState.divDay === undefined) storedState.divDay = DEFAULT_STATE.divDay; 
                if (storedState.used === undefined) storedState.used = DEFAULT_STATE.used; 
                if (storedState.swingProfit === undefined) storedState.swingProfit = 0;
                if (storedState.bottomProfit === undefined) storedState.bottomProfit = 0;

                state = storedState;
            } else { state = DEFAULT_STATE; }
        } catch (e) { 
            console.error("Failed to load state, resetting to default:", e);
            state = DEFAULT_STATE; 
        }

        // --- æ ¸å¿ƒå·¥å…·å‡½æ•¸ ---
        function calculateCurrentEquity() {
            const p = parseFloat(document.getElementById('price').value) || 0;
            return state.cash + (state.holding.longTerm + state.holding.swing + state.holding.bottom) * p;
        }
        
        function getAvgCost(bucket) {
             return state.holding[bucket] > 0 ? state.used[bucket] / state.holding[bucket] : 0;
        }

        // --- è‡ªå‹•åŒæ­¥å¸‚åƒ¹ (ä¿æŒä¸è®Š) ---
        async function syncMarket(isManual = false) {
            const statusEl = document.getElementById('syncStatus');
            const dot = document.getElementById('syncDot');
            const priceEl = document.getElementById('price');
            
            if (!isManual) {
                priceEl.value = INITIAL_PRICE.toFixed(2);
                document.getElementById('divSetting').value = INITIAL_DIV.toFixed(3);
                updateUI();
            }
            
            statusEl.innerText = "æ›´æ–°ä¸­...";
            statusEl.className = "text-xs font-bold text-slate-400";
            dot.className = "dot dot-red";

            try {
                // æ¨¡æ“¬ API å‘¼å«ï¼Œå¯¦éš›éƒ¨ç½²æ™‚è«‹æ›¿æ›ç‚ºçœŸå¯¦çš„ API æ¥å£
                // æ¨¡æ“¬å¸‚åƒ¹æ³¢å‹•
                const marketPrice = INITIAL_PRICE * (1 + (Math.random() - 0.5) * 0.1); 

                if (marketPrice > 0) {
                    priceEl.value = marketPrice.toFixed(2);
                    document.getElementById('lastSyncTime').innerText = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    statusEl.innerText = "å·²é€£ç·š (è‡ªå‹•)";
                    statusEl.className = "text-xs font-bold text-emerald-600";
                    dot.className = "dot dot-green";
                } else {
                    throw new Error("Invalid Price");
                }
                
            } catch (e) { 
                statusEl.innerText = "æ‰‹å‹•/é›¢ç·š";
                statusEl.className = "text-xs font-bold text-slate-400";
                dot.className = "dot dot-red";
                if (!priceEl.value || isManual) priceEl.value = INITIAL_PRICE.toFixed(2); 
            }
            
            updateUI();
        }

        // --- V31: æ›´æ–°ä»½é¡æ¦‚æ³ (ç›ˆè™§) (ä¿æŒä¸è®Š) ---
        function updateBucketStats() {
            const p = parseFloat(document.getElementById('price').value) || 0;

            ['longTerm', 'swing', 'bottom'].forEach(bucket => {
                const avg = getAvgCost(bucket);
                const shares = state.holding[bucket];
                
                document.getElementById(`${bucket}Avg`).innerText = avg.toFixed(2);
                document.getElementById(`${bucket}Shares`).innerText = shares.toLocaleString();

                const cost = state.used[bucket];
                const marketValue = shares * p;
                const pl = marketValue - cost;
                const plPct = cost > 0 ? (pl / cost) * 100 : 0;

                const plEl = document.getElementById(`${bucket}PL`);
                const plPctEl = document.getElementById(`${bucket}PLPct`);
                const cardEl = document.getElementById(`${bucket}Stats`);
                const titleColor = bucket === 'longTerm' ? 'text-blue-500' : bucket === 'swing' ? 'text-orange-500' : 'text-rose-500';
                const textColor = bucket === 'longTerm' ? 'text-blue-400' : bucket === 'swing' ? 'text-orange-400' : 'text-rose-400';

                plEl.innerText = (pl >= 0 ? "+" : "") + Math.round(pl).toLocaleString();
                plPctEl.innerText = (plPct >= 0 ? "+" : "") + plPct.toFixed(2) + "%";

                if (pl >= 0) {
                    plEl.className = 'block text-sm font-black text-emerald-600 mono';
                    plPctEl.className = 'block text-[10px] font-bold text-emerald-500';
                    cardEl.style.backgroundColor = bucket === 'longTerm' ? '#eff6ff' : bucket === 'swing' ? '#fff7ed' : '#fef2f2'; 
                    cardEl.style.borderColor = bucket === 'longTerm' ? '#bfdbfe' : bucket === 'swing' ? '#fed7aa' : '#fecaca'; 
                } else {
                    plEl.className = 'block text-sm font-black text-rose-600 mono';
                    plPctEl.className = 'block text-[10px] font-bold text-rose-500';
                    cardEl.style.backgroundColor = bucket === 'longTerm' ? '#f0f4ff' : bucket === 'swing' ? '#fff0e5' : '#feebeb'; 
                    cardEl.style.borderColor = bucket === 'longTerm' ? '#d7e2ff' : bucket === 'swing' ? '#ffdfc5' : '#ffc0c0'; 
                }

                // é‡æ–°è¨­ç½®æ¨™é¡Œé¡è‰²ä»¥é¿å…è¢«ä¸Šé¢çš„é‚è¼¯è¦†è“‹
                cardEl.querySelector('.uppercase').className = `block text-[10px] font-bold ${titleColor} uppercase`;
                cardEl.querySelector('.text-xs').className = `block text-xs ${textColor}`;


            });
        }


        // --- UI å’Œæ•¸æ“šè™•ç† (ä¿æŒä¸è®Š) ---
        function updateUI() {
            try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch (e) {}
            
            const p = parseFloat(document.getElementById('price').value) || 0;
            const div = parseFloat(document.getElementById('divSetting').value) || 0;
            const bucket = document.getElementById('bucket').value;
            const sharesInput = parseInt(document.getElementById('shares').value) || 0;
            
            recordPerformance();
            
            const totalEq = calculateCurrentEquity();
            const yieldVal = p > 0 ? (div * 12 / p * 100) : 0;

            const currentAvg = getAvgCost(bucket);
            document.getElementById('avgCostDisplay').innerText = `å‡åƒ¹: $${currentAvg.toFixed(2)}`;
            
            // V31: ä»½é¡é¡åº¦è¨ˆç®—
            const bucketLimit = TOTAL_CAPITAL * RATIOS[bucket];
            const remainingLimit = Math.max(0, bucketLimit - state.used[bucket]);
            
            const limitRow = document.getElementById('limitRow');
            const projectedDivRow = document.getElementById('projectedDivRow');
            const profitIndicator = document.getElementById('profitIndicator');

            if (currentMode === 'BUY') {
                limitRow.classList.remove('hidden');
                projectedDivRow.classList.remove('hidden');
                profitIndicator.classList.add('hidden');
                
                document.getElementById('bucketLimit').innerText = `+$${Math.round(remainingLimit).toLocaleString()}`;
                
                const addedMonthlyInterest = sharesInput * div;
                document.getElementById('projectedDiv').innerText = `+$${Math.round(addedMonthlyInterest).toLocaleString()}`;
            } else { // SELL Mode
                limitRow.classList.add('hidden');
                projectedDivRow.classList.add('hidden');
                
                if (currentAvg > 0 && p > 0) {
                    profitIndicator.classList.remove('hidden');
                    const pct = ((p - currentAvg) / currentAvg) * 100;
                    profitIndicator.className = `flex justify-between items-center p-2 rounded-lg text-sm ${pct >= 0 ? 'bg-emerald-100 text-emerald-800' : 'bg-rose-100 text-rose-800'}`;
                    document.getElementById('profitPct').innerText = (pct > 0 ? "+" : "") + pct.toFixed(2) + "%";
                } else { profitIndicator.classList.add('hidden'); }
            }

            document.getElementById('totalEquity').innerText = "$" + Math.round(totalEq).toLocaleString();
            const roi = ((totalEq - TOTAL_CAPITAL) / TOTAL_CAPITAL) * 100;
            document.getElementById('totalRoi').innerText = (roi >= 0 ? "+" : "") + roi.toFixed(1) + "%";
            document.getElementById('totalRoi').className = `bg-${roi >= 0 ? 'emerald' : 'rose'}-100 text-${roi >= 0 ? 'emerald' : 'rose'}-700 px-2 py-1 rounded-md text-xs font-bold`;

            document.getElementById('cashBal').innerText = "$" + Math.round(state.cash).toLocaleString();
            document.getElementById('totalDividends').innerText = "$" + Math.round(state.totalDividends).toLocaleString();
            document.getElementById('swingProfit').innerText = "$" + Math.round(state.swingProfit).toLocaleString();
            document.getElementById('bottomProfit').innerText = "$" + Math.round(state.bottomProfit).toLocaleString();
            
            updateBucketStats(); // V31: æ›´æ–°ä»½é¡ç›ˆè™§

            const signal = document.getElementById('adviceSignal');
            const desc = document.getElementById('adviceDesc');
            document.getElementById('yieldValue').innerText = yieldVal.toFixed(1) + "%";
            if (yieldVal >= 16) {
                signal.innerText = "ğŸš€ æ’ˆåº•æ©Ÿæœƒ (æ¯ç‡æ¥µé«˜)"; signal.className = "text-md font-bold text-rose-600";
                desc.innerText = "å»ºè­°ï¼šå‹•ç”¨ç´…è‰²ä»½é¡é€²å ´ã€‚";
            } else if (yieldVal >= 14) {
                signal.innerText = "ğŸ“ˆ åƒ¹å€¼å€é–“ (é©å®œé•·ç·š)"; signal.className = "text-md font-bold text-blue-600";
                desc.innerText = "å»ºè­°ï¼šç´¯ç©è—è‰²é•·ç·šæ ¸å¿ƒã€‚";
            } else {
                signal.innerText = "ğŸ›¡ï¸ è§€å¯Ÿ/é˜²å®ˆ (æ¯ç‡ä¸€èˆ¬)"; signal.className = "text-md font-bold text-orange-600";
                desc.innerText = "å»ºè­°ï¼šåˆ©ç”¨æ©™è‰²ä»½é¡åšæ³¢æ®µã€‚";
            }

            const sel = document.getElementById('divDaySelect');
            if (sel.value) state.divDay = parseInt(sel.value);
            const today = new Date();
            let nextDate = new Date(today.getFullYear(), today.getMonth(), state.divDay);
            if (today.getDate() >= state.divDay) nextDate.setMonth(today.getMonth() + 1);
            const daysLeft = Math.ceil((nextDate - today) / (1000 * 60 * 60 * 24));
            document.getElementById('countdown').innerText = "å€’æ•¸ " + daysLeft + " å¤©";

            if (allocChart) {
                allocChart.data.datasets[0].data = [state.holding.longTerm*p, state.holding.swing*p, state.holding.bottom*p, state.cash];
                allocChart.update();
            }
            
            const calcPct = (val) => totalEq > 0 ? ((val*p/totalEq)*100).toFixed(0) + "%" : "0%";
            document.getElementById('v1_label').innerText = calcPct(state.holding.longTerm);
            document.getElementById('v2_label').innerText = calcPct(state.holding.swing);
            document.getElementById('v3_label').innerText = calcPct(state.holding.bottom);
            document.getElementById('estAmount').innerText = "$" + Math.round(p * sharesInput).toLocaleString();

            renderLogs();
            renderPerformanceChart(); 
        }

        // --- äº¤æ˜“é‚è¼¯ (ä¿æŒä¸è®Š) ---
        function execute() {
            const p = parseFloat(document.getElementById('price').value);
            const s = parseInt(document.getElementById('shares').value);
            const b = document.getElementById('bucket').value;
            const amt = p * s;
            if (s <= 0 || p <= 0) return alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„è‚¡æ•¸å’Œå¸‚åƒ¹");

            if (currentMode === 'BUY') {
                const bucketLimit = TOTAL_CAPITAL * RATIOS[b];
                const newUsed = state.used[b] + amt;

                // V31: é™é¡é–å®šé‚è¼¯
                if (state.cash < amt) return alert("ç¾é‡‘ä¸è¶³ã€‚");
                if (newUsed > bucketLimit) return alert(`ä»½é¡è¶…é¡ï¼${NAMES[b]} çš„ç¸½æŠ•è³‡ä¸Šé™ç‚º $${bucketLimit.toLocaleString()}ï¼Œç•¶å‰æ“ä½œå°‡è¶…é¡ $${Math.round(newUsed - bucketLimit).toLocaleString()}ã€‚`);
                
                state.cash -= amt; 
                state.holding[b] += s; 
                state.used[b] += amt;
                log(`è²·å…¥ ${s}è‚¡ [${NAMES[b]}]`, -amt, 'BUY', b, s, p);
            } else {
                if (state.holding[b] < s) return alert("æŒå€‰ä¸è¶³");
                const avg = getAvgCost(b);
                const cost = avg * s;
                const profit = amt - cost;
                
                state.cash += amt; 
                state.holding[b] -= s; 
                state.used[b] = Math.max(0, state.used[b] - cost);
                
                if (b === 'swing') state.swingProfit += profit;
                if (b === 'bottom') state.bottomProfit += profit;
                
                log(`æ²½å‡º ${s}è‚¡ [${NAMES[b]}]`, amt, 'SELL', b, s, p, avg);
            }
            updateUI();
        }

        function setMax() {
            const p = parseFloat(document.getElementById('price').value) || 0;
            if (p <= 0) return;
            
            const b = document.getElementById('bucket').value;
            let maxShares;

            if (currentMode === 'BUY') {
                const bucketLimit = TOTAL_CAPITAL * RATIOS[b];
                const remainingLimit = Math.max(0, bucketLimit - state.used[b]);
                
                // å¯ç”¨è³‡é‡‘æ˜¯ç¾é‡‘å’Œä»½é¡å‰©é¤˜é¡åº¦ä¸­çš„æœ€å°å€¼ (V31 æ ¸å¿ƒé™åˆ¶)
                const canSpend = Math.min(remainingLimit, state.cash);
                
                maxShares = Math.floor(canSpend / p);
                
            } else {
                maxShares = state.holding[b];
            }
            document.getElementById('shares').value = Math.max(0, maxShares);
            updateUI();
        }

        function recordPerformance() {
            const currentDate = new Date().toISOString().substring(0, 10); 
            const currentEquity = Math.round(calculateCurrentEquity());
            
            const lastRecord = state.performanceHistory[state.performanceHistory.length - 1];

            if (lastRecord.date !== currentDate || Math.abs(lastRecord.equity - currentEquity) > 1000) {
                if (lastRecord.date === currentDate) {
                    lastRecord.equity = currentEquity;
                } else {
                    state.performanceHistory.push({ date: currentDate, equity: currentEquity });
                    if (state.performanceHistory.length > 100) state.performanceHistory.shift(); 
                }
            }
        }

        function renderPerformanceChart(mode = currentChartMode) {
            currentChartMode = mode;
            document.getElementById('toggleMonthly').className = `chart-toggle-btn ${mode === 'monthly' ? 'chart-toggle-active' : 'chart-toggle-inactive'}`;
            document.getElementById('toggleYearly').className = `chart-toggle-btn ${mode === 'yearly' ? 'chart-toggle-active' : 'chart-toggle-inactive'}`;

            let filteredData = state.performanceHistory;
            let labels = filteredData.map(d => d.date);
            let equities = filteredData.map(d => d.equity);

            if (mode === 'monthly') {
                filteredData = state.performanceHistory.slice(-30);
                labels = filteredData.map(d => d.date.substring(5)); 
            } else if (mode === 'yearly') {
                labels = filteredData.map(d => d.date.substring(0, 7)); 
            }

            if (performanceChart) {
                performanceChart.data.labels = labels;
                performanceChart.data.datasets[0].data = equities;
                performanceChart.update();
                return;
            }

            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ç¸½è³‡ç”¢æ·¨å€¼',
                        data: equities,
                        borderColor: '#6366f1', 
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        fill: 'start', 
                        tension: 0.4, 
                        pointRadius: 3,
                        pointBackgroundColor: '#6366f1',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        x: { display: true, title: { display: true, text: 'æ—¥æœŸ', color: '#64748b' } },
                        y: { 
                            display: true, 
                            title: { display: true, text: 'æ·¨å€¼ (HKD)', color: '#64748b' },
                            ticks: { callback: (val) => '$' + (val / 1000).toFixed(0) + 'K' } 
                        }
                    }
                }
            });
        }

        function log(msg, amt, type, bucket, shares, price, avg=0) {
            const time = new Date();
            const dateStr = `${time.getMonth()+1}/${time.getDate()}`;
            const newLog = { id: Date.now(), date: dateStr, msg, amt, type, bucket, shares, price, avg };
            state.logs.unshift(newLog);
            if (state.logs.length > 50) state.logs.pop();
        }

        function deleteLog(id) {
            const index = state.logs.findIndex(l => l.id === id);
            if (index === -1) return;
            
            const logEntry = state.logs[index];

            if (!confirm(`ç¢ºå®šåˆªé™¤æ­¤è¨˜éŒ„ï¼Ÿ\n[${logEntry.date}] ${logEntry.msg}`)) return;

            if (logEntry.type === 'BUY') {
                state.cash += logEntry.shares * logEntry.price;
                state.holding[logEntry.bucket] -= logEntry.shares;
                state.used[logEntry.bucket] -= logEntry.shares * logEntry.price;
            } else if (logEntry.type === 'SELL') {
                const cost = logEntry.shares * logEntry.avg;
                const profit = (logEntry.shares * logEntry.price) - cost;
                
                state.cash -= logEntry.shares * logEntry.price;
                state.holding[logEntry.bucket] += logEntry.shares;
                state.used[logEntry.bucket] += cost;

                if (logEntry.bucket === 'swing') state.swingProfit -= profit;
                if (logEntry.bucket === 'bottom') state.bottomProfit -= profit;

            } else if (logEntry.type === 'DIV') {
                state.cash -= logEntry.amt;
                state.totalDividends -= logEntry.amt;
            }

            state.holding[logEntry.bucket] = Math.max(0, state.holding[logEntry.bucket] || 0);
            state.used[logEntry.bucket] = Math.max(0, state.used[logEntry.bucket] || 0);

            state.logs.splice(index, 1);
            
            alert("è¨˜éŒ„å·²åˆªé™¤ï¼Œå¸³æˆ¶æ•¸æ“šå·²é‚„åŸï¼");
            updateUI();
        }


        function renderLogs() {
            document.getElementById('logBody').innerHTML = state.logs.map(l => `
                <div class="px-5 py-2 flex justify-between items-center hover:bg-slate-50 transition group">
                    <div class="flex-1">
                        <span class="block text-xs font-bold text-slate-700">${l.msg}</span>
                        <span class="text-[10px] text-slate-400 mono">${l.date}</span>
                    </div>
                    <span class="font-bold mono text-sm ${l.amt>=0 ? 'text-emerald-600' : 'text-slate-800'} mr-4">
                        ${l.amt>=0?'+':''}${Math.round(l.amt).toLocaleString()}
                    </span>
                    <button onclick="deleteLog(${l.id})" class="delete-btn">
                        ğŸ—‘ï¸
                    </button>
                </div>
            `).join('');
        }

        function collectDiv() {
            const div = parseFloat(document.getElementById('divSetting').value);
            const totalS = state.holding.longTerm + state.holding.swing + state.holding.bottom;
            if (totalS <= 0) return alert("ç„¡æŒå€‰");
            const earned = div * totalS;
            state.cash += earned; state.totalDividends += earned;
            log(`æ”¶å–è‚¡æ¯`, earned, 'DIV', 'N/A', 0, 0); 
            updateUI();
        }

        function switchMode(mode) {
            currentMode = mode;
            const buyBtn = document.getElementById('buyModeBtn');
            const sellBtn = document.getElementById('sellModeBtn');
            const execBtn = document.getElementById('execBtn');
            
            if (mode === 'BUY') {
                buyBtn.className = "py-3 rounded-xl font-bold text-sm transition btn-press mode-active-buy shadow-lg shadow-slate-200";
                sellBtn.className = "py-3 rounded-xl font-bold text-sm transition btn-press mode-inactive";
                execBtn.innerText = "ç¢ºèªè²·å…¥ (BUY)";
                execBtn.className = "col-span-3 py-4 bg-slate-800 text-white rounded-xl font-bold text-md shadow-lg shadow-slate-300/50 btn-press";
            } else {
                buyBtn.className = "py-3 rounded-xl font-bold text-sm transition btn-press mode-inactive";
                sellBtn.className = "py-3 rounded-xl font-bold text-sm transition btn-press mode-active-sell shadow-lg shadow-rose-200";
                execBtn.innerText = "ç¢ºèªæ²½å‡º (SELL)";
                execBtn.className = "col-span-3 py-4 bg-rose-600 text-white rounded-xl font-bold text-md shadow-lg shadow-rose-300/50 btn-press";
            }
            updateUI();
        }

        function resetData() { 
            if(confirm("é‡ç½®å°‡æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Œç¢ºå®šï¼Ÿ")) { 
                localStorage.removeItem(STORAGE_KEY); 
                location.reload(); 
            } 
        }

        function initDivSelector() {
            const s = document.getElementById('divDaySelect');
            for(let i=1; i<=28; i++) s.innerHTML += `<option value="${i}">${i}è™Ÿ</option>`;
            s.value = state.divDay || 7; 
        }

        function getGradient(ctx, chartArea, colorStart, colorEnd) {
            const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
            gradient.addColorStop(0, colorStart);
            gradient.addColorStop(1, colorEnd);
            return gradient;
        }

        window.onload = () => {
            initDivSelector();
            
            const ctx = document.getElementById('allocChart').getContext('2d');
            
            const chartData = {
                labels: ['é•·ç·š','æ³¢å¹…','æ’ˆåº•','ç¾é‡‘'],
                datasets: [{ 
                    data: [0,0,0,100], 
                    backgroundColor: function(context) {
                        const chart = context.chart;
                        const {ctx, chartArea} = chart;
                        if (!chartArea) return null;
                        
                        if (context.dataIndex === 0) return getGradient(ctx, chartArea, '#2563eb', '#60a5fa'); 
                        if (context.dataIndex === 1) return getGradient(ctx, chartArea, '#ea580c', '#fb923c'); 
                        if (context.dataIndex === 2) return getGradient(ctx, chartArea, '#e11d48', '#f43f5e'); 
                        return '#f1f5f9';
                    },
                    borderWidth: 0,
                    hoverOffset: 15, 
                    borderRadius: 5  
                }] 
            };

            allocChart = new Chart(ctx, {
                type: 'doughnut',
                data: chartData,
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    cutout: '75%', 
                    layout: { padding: 10 },
                    plugins: { legend: { display: false }, tooltip: { enabled: false } } 
                }
            });
            
            renderPerformanceChart(currentChartMode); 
            
            syncMarket(); 
            setInterval(syncMarket, 60000);
        };
    </script>
</body>
</html>

